<html>
	<script>
	
	var result = null;
	var activeTabId = null;
	var activeTab = null;
	
	function checkLogin()
	{
		var xhr = new XMLHttpRequest();
		xhr.open("GET", "http://api.quora.com/api/logged_in_user?fields=inbox,notifs", true);
		xhr.onreadystatechange = function() {
	  		if (xhr.readyState == 4) {
    		    try
	    		{
	    			result = JSON.parse(xhr.responseText.match(/{.*}/));
	    		}catch(ex)
	    		{
	    			
	    			result = null;
	    		}finally
	    		{
	    			update();
	    			setTimeout("checkLogin();", 3000);
	    		}  	   
	  		}
		}
		xhr.send();
	}	
	
	function userNotLoggedIn()
	{
		updateBadgeText("");
	}
	
	function userLoggedIn()
	{
		if(null == result)
		{
			return; 
		}
		
		notifications = parseInt(result.notifs.unseen_aggregated_count);
		inbox = parseInt(result.inbox.unread_count);
		total = notifications + inbox;
		
		if(total > 0)
		{
			updateBadgeText(total.toString());	
		}else
		{
			updateBadgeText("");	
		}
	}
	
	function update()
	{
		if(null == result)
		{
			userNotLoggedIn();
		}else
		{
			userLoggedIn();
		}
	}
	
	function updateBadgeText(text)
	{
		chrome.browserAction.setBadgeText({"text": text})
	}
	
	function createContextMenu()
	{
		chrome.contextMenus.create({"title":"Post to Quora", "onclick": contextPost});
		chrome.contextMenus.create({"title":"Post this link to Quora", "onclick": contextPostUrl, "contexts":["link"]});
		chrome.contextMenus.create({"title":"Post this image to Quora", "onclick": contextPostImage, "contexts":["image"]});
		chrome.contextMenus.create({"title":"Search on Quora", "onclick": contextSearch, "contexts":['selection']});
	}
	
	function contextPostUrl(clickInfo, tab)
	{
		if(clickInfo.linkUrl != null && clickInfo.linkUrl != "")
		{
			postToQuora(clickInfo.linkUrl);
		}
	}
	
	function contextPostImage(clickInfo, tab)
	{
		if(clickInfo.srcUrl != null && clickInfo.srcUrl != "")
		{
			postToQuora(clickInfo.srcUrl);
		}
	}
	
	function contextSearch(clickInfo, tab)
	{
		if(clickInfo.selectionText != null && clickInfo.selectionText != "")
		{
			searchOnQuora(clickInfo.selectionText);
		}
	}
	
	function contextPost(clickInfo, tab)
	{
		postToQuora(tab.url);
	}
	
	function postToQuora(url)
	{
		link = "http://www.quora.com/board/bookmarklet?v=1&url="+encodeURIComponent(url);	
		window.open(link,'_blank','toolbar=0,scrollbars=no,resizable=1,status=1,width=430,height=400')
	}
	
	function searchOnQuora(topic)
	{
		url = "http://www.quora.com/search?q="+encodeURIComponent(topic);
		create = {"url": url};
		chrome.tabs.create(create);
	}
	
	function run()
	{
		chrome.extension.onRequest.addListener(
		function(request, sender, sendResponse) {
			
		    if (request.data == "login")
		    {
		      sendResponse({"result": result});
		    }
		    else if(request.data == "search")
		    {
		    	searchOnQuora(request.query);
		    }
		    else if(request.data == "post")
		    {
		    	if(activeTabId != null)
		    	{
		    		chrome.tabs.get(activeTabId, function(tab)
			    		{ 
			    			if(tab == null)
			    			{
			    				if(activeTab != null)
			    				{
			    					postToQuora(activeTab.url);
			    				}else
			    				{
			    					alert("Error: Could not perform requested task.");
			    				}
			    			}else
			    			{
			    				activeTab = tab;
			    				postToQuora(tab.url);
			    			}
			    			
			    		}
		    		);
		    	}
		    }
		    else
		    {
		    	alert(request.data);
		     	sendResponse({});
		    }
		    
		});
		createContextMenu();
		checkLogin();
		chrome.tabs.onActiveChanged.addListener(function(tabId, selectInfo){ activeTabId = tabId;});
	}
	run();
	</script>
</html>